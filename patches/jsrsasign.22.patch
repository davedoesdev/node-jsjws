From 3c6b82be9e643011987d5c12e79aa4f876f00088 Mon Sep 17 00:00:00 2001
From: David Halls <dahalls@gmail.com>
Date: Sun, 18 Aug 2013 22:28:00 +0100
Subject: [PATCH] Fixes for strict mode Change default salt len to be hash
 length to match JOSE (see
 http://www.ietf.org/mail-archive/web/jose/current/msg02905.html)

---
 ext/base64.js  |  1 +
 rsasign-1.2.js | 11 +++++------
 2 files changed, 6 insertions(+), 6 deletions(-)

diff --git a/ext/base64.js b/ext/base64.js
index b99be0a..3daad06 100644
--- a/ext/base64.js
+++ b/ext/base64.js
@@ -27,6 +27,7 @@ function b64tohex(s) {
   var i;
   var k = 0; // b64 state, 0-3
   var slop;
+  var v;
   for(i = 0; i < s.length; ++i) {
     if(s.charAt(i) == b64pad) break;
     v = b64map.indexOf(s.charAt(i));
diff --git a/rsasign-1.2.js b/rsasign-1.2.js
index 2aca2a4..cebd5f1 100644
--- a/rsasign-1.2.js
+++ b/rsasign-1.2.js
@@ -74,8 +74,7 @@ function _rsasign_getHexPaddedDigestInfoForString(s, keySize, hashAlg) {
     for (var i = 0; i < fLen; i += 2) {
 	sMid += "ff";
     }
-    sPaddedMessageHex = sHead + sMid + sTail;
-    return sPaddedMessageHex;
+    return sHead + sMid + sTail;
 }
 
 function _zeroPaddingOfSignature(hex, bitLength) {
@@ -148,9 +147,9 @@ function _rsasign_signStringPSS(s, hashAlg, sLen) {
     var emLen = Math.ceil(emBits / 8);
     var i;
 
-    if (sLen === -1) {
+    if ((sLen === -1) || (sLen === undefined)) {
         sLen = hLen; // same as hash length
-    } else if ((sLen === -2) || (sLen === undefined)) {
+    } else if (sLen === -2) {
         sLen = emLen - hLen - 2; // maximum
     } else if (sLen < -2) {
         throw "invalid salt length";
@@ -297,9 +296,9 @@ function _rsasign_verifyStringPSS(sMsg, hSig, hashAlg, sLen) {
     var emLen = Math.ceil(emBits / 8);
     var i;
 
-    if (sLen === -1) {
+    if ((sLen === -1) || (sLen === undefined)) {
         sLen = hLen; // same as hash length
-    } else if ((sLen === -2) || (sLen === undefined)) {
+    } else if (sLen === -2) {
         sLen = emLen - hLen - 2; // recover
     } else if (sLen < -2) {
         throw "invalid salt length";
-- 
1.8.1.6
